name: Deploy to Bluehost (SSH/rsync)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: bluehost-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # If you build a static site, add your build here and set SOURCE below to the build folder.

      - name: Configure SSH (force only our key)
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Preload host key to avoid interactive prompt
          ssh-keyscan -p 22 "${{ secrets.BH_HOST }}" >> ~/.ssh/known_hosts
          # Use only our key for this host
          {
            echo "Host ${{ secrets.BH_HOST }}"
            echo "  HostName ${{ secrets.BH_HOST }}"
            echo "  User ${{ secrets.BH_USER }}"
            echo "  Port 22"
            echo "  IdentitiesOnly yes"
            echo "  PreferredAuthentications publickey"
          } >> ~/.ssh/config
          chmod 600 ~/.ssh/config ~/.ssh/known_hosts

      - name: Deploy via SSH (rsync)
        uses: easingthemes/ssh-deploy@v2
        env:
          SSH_PRIVATE_KEY: ${{ secrets.BH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.BH_HOST }}
          REMOTE_USER: ${{ secrets.BH_USER }}
          REMOTE_PORT: "22"
          # If you build, change SOURCE to your build output, e.g. "./dist/" or "./out/"
          SOURCE: "./"
          TARGET: ${{ secrets.BH_REMOTE_PATH }}   # e.g., /home2/evanmish/public_html/
          # rsync args:
          ARGS: "-az --delete --checksum --omit-dir-times --no-perms --no-owner --no-group"
          EXCLUDE: ".git*,.github,node_modules,.DS_Store"
